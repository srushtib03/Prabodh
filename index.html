<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRABODH | Student Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --p: #6366f1; --s: #a855f7; --bg: #0f172a; --accent: #f59e0b; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .glass-card { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 30px; border-radius: 25px; width: 90%; max-width: 800px; border: 1px solid rgba(255,255,255,0.2); text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .hidden { display: none; }
        input, textarea { width: 100%; padding: 15px; border-radius: 12px; border: none; margin: 10px 0; font-size: 1.1rem; background: rgba(255,255,255,0.9); color: #0f172a; box-sizing: border-box; }
        button { width: 100%; padding: 15px; border-radius: 12px; border: none; background: linear-gradient(to right, var(--p), var(--s)); color: white; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.3s; margin-top: 10px; }
        button:hover { transform: scale(1.02); opacity: 0.9; }
        button:disabled { background: #4b5563; cursor: not-allowed; }
        
        /* BLIND MODE THEME */
        body.blind-mode { background: #000; color: var(--accent); }
        body.blind-mode .glass-card { border: 5px solid var(--accent); background: #111; }
        body.blind-mode button { background: var(--accent); color: #000; font-size: 1.8rem; height: 100px; }
        body.blind-mode input { font-size: 1.5rem; }

        /* DEAF MODE THEME */
        .deaf-ui { border: 4px solid #0ea5e9 !important; }
        .reading-section { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-top: 20px; text-align: left; border-left: 5px solid #0ea5e9; }
        
        #status-indicator { font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px; }
    </style>
</head>
<body onload="init()">
    <div class="glass-card" id="main-card">
        <h1>PRABODH</h1>
        <div id="status-indicator">System Connected</div>
        <p id="welcome-msg">Preparing your session...</p>

        <div id="search-area">
            <input type="text" id="topic-input" placeholder="What do you want to learn? (e.g. Gravity)">
            <button id="start-btn" onclick="startLearning()">Get Question & Start</button>
        </div>

        <div id="quiz-area" class="hidden">
            <h2 id="question-display" style="color: #60a5fa; margin-bottom: 20px;"></h2>
            <textarea id="answer-input" rows="4" placeholder="Type or speak your answer clearly..."></textarea>
            <button id="submit-btn" onclick="submitAnswer()">Submit My Answer</button>
        </div>

        <div id="result-area" class="hidden">
            <h3 style="color: var(--p);">Analysis Result</h3>
            <p id="feedback-text" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; line-height: 1.6; text-align: left;"></p>
            <iframe id="yt-player" width="100%" height="350" src="" frameborder="0" style="border-radius: 15px; margin-top: 15px;" allowfullscreen></iframe>
            <button onclick="location.reload()" style="margin-top:20px; background: #334155;">Study Another Topic</button>
        </div>

        <div id="book-section" class="reading-section hidden">
            <h4 style="margin:0; color:#0ea5e9;">ðŸ“š Visual Reading Room</h4>
            <p id="book-content" style="font-size: 0.95rem; color: #e2e8f0; margin-top: 10px;">
                Topic notes will appear here once you start.
            </p>
        </div>
    </div>

<script>
    let studentName = "", studentPhone = "", mode = 'default', topic = "", step = 'topic', processing = false;

    function init() {
        const urlParams = new URLSearchParams(window.location.search);
        mode = urlParams.get('mode') || 'default';
        studentName = urlParams.get('name') || 'Student';
        studentPhone = urlParams.get('phone') || 'Unknown';
        
        document.getElementById('welcome-msg').innerText = `Namaste, ${studentName}.`;

        if (mode === 'blind') {
            document.body.classList.add('blind-mode');
            speak(`Welcome ${studentName} to Prabodh. Press the Enter key once, then speak your topic.`);
        } else if (mode === 'deaf') {
            document.getElementById('main-card').classList.add('deaf-ui');
            document.getElementById('book-section').classList.remove('hidden');
        }
    }

    function speak(msg) {
        if (mode === 'deaf') return; // Deaf students don't need audio
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(msg);
        utterance.rate = 0.9;
        window.speechSynthesis.speak(utterance);
    }

    // Enter Key Handler for Accessibility (Blind Mode)
    document.addEventListener('keydown', (e) => {
        if (mode === 'blind' && e.key === 'Enter' && !processing) {
            if (step === 'topic') listen('topic');
            else if (step === 'answer') listen('answer');
            else if (step === 'confirm_topic') startLearning();
            else if (step === 'confirm_answer') submitAnswer();
        }
    });

    function listen(target) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) { alert("Speech not supported on this browser."); return; }
        
        processing = true;
        const rec = new SpeechRecognition();
        rec.lang = 'en-IN';
        rec.start(); 
        
        document.getElementById('status-indicator').innerText = "ðŸŽ¤ Listening...";
        speak("Listening now...");

        rec.onresult = (e) => {
            const val = e.results[0][0].transcript;
            document.getElementById('status-indicator').innerText = "System Ready";
            
            if (target === 'topic') {
                document.getElementById('topic-input').value = val;
                topic = val; 
                step = 'confirm_topic';
                speak(`I heard ${val}. Press Enter again to confirm.`);
            } else {
                document.getElementById('answer-input').value = val;
                step = 'confirm_answer';
                speak(`I recorded your answer. Press Enter again to submit.`);
            }
            processing = false;
        };

        rec.onerror = () => {
            processing = false;
            document.getElementById('status-indicator').innerText = "Error. Try again.";
            speak("Sorry, I didn't catch that. Press Enter to try again.");
        }
    }

    async function startLearning() {
        topic = document.getElementById('topic-input').value;
        if (!topic) { alert("Please enter a topic first!"); return; }

        document.getElementById('start-btn').disabled = true;
        document.getElementById('start-btn').innerText = "Generating Question...";

        try {
            const res = await fetch('/api/start_quiz', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    name: studentName, 
                    phone: studentPhone, 
                    topic: topic, 
                    mode: mode 
                })
            });
            const data = await res.json();
            
            document.getElementById('search-area').classList.add('hidden');
            document.getElementById('quiz-area').classList.remove('hidden');
            document.getElementById('question-display').innerText = data.question;
            
            if (mode === 'deaf') {
                document.getElementById('book-content').innerText = `Lesson Summary for ${topic}: Focus on the key principles. Review the AI question below carefully before answering.`;
            }

            step = 'answer';
            speak(data.question);
        } catch (err) {
            alert("Connection error. Is main.py running?");
        } finally {
            document.getElementById('start-btn').disabled = false;
        }
    }

    async function submitAnswer() {
        const ans = document.getElementById('answer-input').value;
        if (!ans) { alert("Please provide an answer first!"); return; }

        document.getElementById('submit-btn').disabled = true;
        document.getElementById('submit-btn').innerText = "AI Analyzing...";

        try {
            const res = await fetch('/api/submit_answer', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    name: studentName, 
                    phone: studentPhone, 
                    topic: topic, 
                    user_answer: ans, 
                    mode: mode 
                })
            });
            const data = await res.json();
            
            document.getElementById('quiz-area').classList.add('hidden');
            document.getElementById('result-area').classList.remove('hidden');
            document.getElementById('feedback-text').innerText = data.analysis.explanation;
            document.getElementById('yt-player').src = "https://www.youtube.com/embed/" + data.video_id;
            
            speak(data.analysis.explanation);
        } catch (err) {
            alert("Error submitting answer.");
        }
    }
</script>
</body>
</html>